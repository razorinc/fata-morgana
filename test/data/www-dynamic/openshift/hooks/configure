#!/bin/bash
#
# Copyright Â© 2010 Red Hat, Inc. All rights reserved
#
# This copyrighted material is made available to anyone wishing to use, modify,
# copy, or redistribute it subject to the terms and conditions of the GNU
# General Public License v.2.  This program is distributed in the hope that it
# will be useful, but WITHOUT ANY WARRANTY expressed or implied, including the
# implied warranties of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.  You should have
# received a copy of the GNU General Public License along with this program;
# if not, write to the Free Software Foundation, Inc., 51 Franklin Street,
# Fifth Floor, Boston, MA 02110-1301, USA. Any Red Hat trademarks that are
# incorporated in the source code or documentation are not subject to the GNU
# General Public License and may only be used or replicated with the express
# permission of Red Hat, Inc.
#

# Exit on errors.
set -e

# Initialization.
cartridge_name="www-dynamic.apache2"
hook_name=$(basename "$0")
test $OS_TRACE_HOOKS && echo "!DEBUG! :$SHLVL: $hook_name $@"

source ./common.sh


#  Functions.
function copy_defaults() {
   src=${1:-""}
   dest=${2:-""}
 
   [ ! -f "${infile}" ]  &&  die 22 "copy_defaults - invalid source '${src}'"
   [ -z "${outfile}" ]   &&  die 22 "copy_defaults - invalid dest '${dest}'"

   subst_list=""
   for v in `env | grep "^_OPENSHIFT_" | cut -f1 -d '='`; do
      subst_list="${subst_list} s#${$v}#${!v}#g;"
   done
   sed "${subst_list}" "${src}" >  "${dest}"

}  #  End of function  copy_defaults.


function do_configuration() {
   cfgdir=${1:-"/tmp"}
   declare -r platform_type=${_OPENSHIFT_PLATFORM_TYPE:-"/express"}

   #  Configure is called a few times in the lifecycle of the app. 
   cart_cfg_subdir="${cartridge_name}/conf"
   cloc="${cfgdir}/${cart_cfg_subdir}"

   #  Ensure configuration exists for the component.
   if ! test -d "${cloc}"; then
      mkdir -p "${cloc}" "${cloc}/../conf.d/"

      # Copy over the defaults to the app component space.
      copy_defaults "../templates/httpd.conf"  "${cloc}/httpd.conf"
      copy_defaults "../templates/os-${platform_type}.conf"  \
                    "${cloc}/../conf.d/os-${platform_type}.conf"
   fi

}  #  End of function  do_configuration.


#
# _main()
#
os_check_args "$@"  ||  print_usage "Setup www-dynamic.apache2 Component"

app_guid=$1
comp_guid=$2

cfgdir="${_OPENSHIFT_APP_CONFIG_DIR}/$comp_guid"

case "$hook_name" in 
   configure)    do_configuration "${cfgdir}" ;;
   deconfigure)                               ;;
esac


#  Not doing any more in setup right now. Everything else will be done via
#  connectors (setup-connections).

